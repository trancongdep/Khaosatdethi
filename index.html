<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDC Survey Pro v1.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .checklist-item input:checked + span { text-decoration: line-through; color: #9ca3af; }
        @media (min-width: 1024px) { .mobile-only { display: none; } .desktop-only { display: block; } }
        @media (max-width: 1023px) { .mobile-only { display: block; } .desktop-only { display: none; } }
        .tab-active { border-bottom: 3px solid #1d4ed8; color: #1d4ed8; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div class="desktop-only p-8">
        <div class="max-w-7xl mx-auto">
            <header class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm">
                <div>
                    <h1 class="text-2xl font-bold text-slate-800">VDC Project Dashboard</h1>
                    <p class="text-slate-500">Khảo sát An toàn điện VSIP (NĐ 62/2025)</p>
                </div>
                <div class="text-right">
                    <span class="text-xs font-mono bg-blue-100 text-blue-600 px-3 py-1 rounded-full">v1.4</span>
                </div>
            </header>
            <div id="pc-content">
                <p class="text-center text-slate-400">Vui lòng xem trên thiết bị di động để thực hiện khảo sát hiện trường.</p>
            </div>
        </div>
    </div>

    <div class="mobile-only">
        <div class="sticky top-0 z-10 bg-blue-700 text-white p-4 shadow-md">
            <div class="flex justify-between items-center">
                <h1 class="font-bold">VDC SURVEY MOBILE</h1>
                <span id="syncStatus" class="text-[10px] bg-green-500 px-2 py-0.5 rounded">Online</span>
            </div>
        </div>

        <div class="flex bg-white border-b sticky top-[56px] z-10">
            <button onclick="switchTab('survey')" id="tab-survey" class="flex-1 py-3 text-sm tab-active">KHẢO SÁT</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-3 text-sm text-slate-500">DỮ LIỆU ĐÃ LƯU</button>
        </div>

        <div id="survey-section" class="p-4 space-y-4">
            <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-200">
                <form id="surveyForm" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Hạng mục:</label>
                        <select id="category" onchange="updateChecklist()" class="w-full p-3 border rounded-xl bg-slate-50 outline-none">
                            <option value="a">Trạm 110/22kV (M&E)</option>
                            <option value="b">Trạm 22/0.4kV (M&E)</option>
                            <option value="d">SCADA & OCC</option>
                            <option value="f">Xử lý nước thải (W&S)</option>
                            <option value="i">Thi công hạ tầng (CON)</option>
                        </select>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl">
                        <p class="text-xs font-bold text-blue-700 uppercase mb-3 italic">Checklist đảm bảo đầy đủ:</p>
                        <div id="checklist-container" class="space-y-2 text-sm"></div>
                    </div>

                    <textarea id="notes" class="w-full p-3 border rounded-xl bg-slate-50 h-24" placeholder="Mô tả mối nguy/tình huống..."></textarea>

                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex flex-col items-center justify-center p-3 border-2 border-dashed border-blue-200 rounded-xl bg-blue-50 cursor-pointer">
                            <svg class="w-6 h-6 text-blue-600 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            <span class="text-[10px] font-bold text-blue-700">CHỤP ẢNH</span>
                            <input type="file" id="camInput" accept="image/*" capture="environment" class="hidden" onchange="previewFile(this)">
                        </label>
                        <label class="flex flex-col items-center justify-center p-3 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 cursor-pointer">
                            <svg class="w-6 h-6 text-slate-600 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            <span class="text-[10px] font-bold text-slate-700">CHỌN THƯ VIỆN</span>
                            <input type="file" id="libInput" accept="image/*" class="hidden" onchange="previewFile(this)">
                        </label>
                    </div>
                    <p id="fileStatus" class="text-center text-[10px] text-blue-600 font-bold italic"></p>

                    <button type="button" onclick="handleSave()" id="saveBtn" class="w-full bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg">LƯU DỮ LIỆU</button>
                </form>
            </div>
        </div>

        <div id="history-section" class="hidden p-4">
            <div id="history-list" class="space-y-3">
                </div>
        </div>
    </div>

    <script>
        const checklists = {
            a: ["Kiểm tra nối đất trạm", "Kiểm tra rò rỉ dầu máy biến áp", "Kiểm tra tủ điều khiển MK", "Hành lang an toàn"],
            b: ["Khóa liên động", "Khoảng cách an toàn", "Biển báo cảnh báo", "Rơ le bảo vệ"],
            d: ["Nguồn UPS", "Nhiệt độ phòng server", "Trạng thái kết nối RTU"],
            f: ["An toàn tủ điện ngoài trời", "Tiếp địa bơm", "BHLĐ chuyên dụng"],
            i: ["Nguồn tạm thi công", "Rào chắn biển báo", "Dây dẫn điện"]
        };

        let currentFile = null;

        function switchTab(tab) {
            document.getElementById('survey-section').classList.toggle('hidden', tab !== 'survey');
            document.getElementById('history-section').classList.toggle('hidden', tab !== 'history');
            document.getElementById('tab-survey').className = tab === 'survey' ? 'flex-1 py-3 text-sm tab-active' : 'flex-1 py-3 text-sm text-slate-500';
            document.getElementById('tab-history').className = tab === 'history' ? 'flex-1 py-3 text-sm tab-active' : 'flex-1 py-3 text-sm text-slate-500';
            if(tab === 'history') renderHistory();
        }

        function updateChecklist() {
            const cat = document.getElementById('category').value;
            document.getElementById('checklist-container').innerHTML = checklists[cat].map(item => `
                <label class="flex items-center space-x-3 checklist-item">
                    <input type="checkbox" class="w-4 h-4 rounded text-blue-600 border-slate-300">
                    <span class="text-slate-700">${item}</span>
                </label>
            `).join('');
        }

        function previewFile(input) {
            if (input.files && input.files[0]) {
                currentFile = input.files[0];
                document.getElementById('fileStatus').innerText = "Đã chọn: " + currentFile.name;
            }
        }

        async function handleSave() {
            const btn = document.getElementById('saveBtn');
            const categoryText = document.getElementById('category').options[document.getElementById('category').selectedIndex].text;
            const notes = document.getElementById('notes').value;

            if (!notes && !currentFile) return alert("Vui lòng nhập ghi chú hoặc chụp ảnh!");

            btn.disabled = true; btn.innerText = "ĐANG XỬ LÝ...";

            const saveProcess = (base64Data = null) => {
                const item = {
                    id: Date.now(),
                    category: categoryText,
                    notes: notes,
                    timestamp: new Date().toLocaleString('vi-VN'),
                    filename: currentFile ? currentFile.name : "no-image",
                    data: base64Data
                };

                let history = JSON.parse(localStorage.getItem('vdc_history_v1.4') || '[]');
                history.unshift(item); // Thêm lên đầu
                localStorage.setItem('vdc_history_v1.4', JSON.stringify(history));

                // Reset form
                document.getElementById('surveyForm').reset();
                document.getElementById('fileStatus').innerText = "";
                currentFile = null;
                updateChecklist();
                btn.disabled = false; btn.innerText = "LƯU DỮ LIỆU";
                alert("Đã lưu bản ghi!");
            };

            if (currentFile) {
                const reader = new FileReader();
                reader.onload = (e) => saveProcess(e.target.result.split(',')[1]);
                reader.readAsDataURL(currentFile);
            } else {
                saveProcess();
            }
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('vdc_history_v1.4') || '[]');
            const container = document.getElementById('history-list');
            if (history.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-400 py-10">Chưa có dữ liệu khảo sát nào.</p>`;
                return;
            }
            container.innerHTML = history.map(item => `
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-600">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-0.5 rounded">${item.category}</span>
                        <span class="text-[10px] text-slate-400">${item.timestamp}</span>
                    </div>
                    <p class="text-sm text-slate-700 font-medium mb-2">${item.notes || 'Không có mô tả'}</p>
                    ${item.data ? `<div class="text-[10px] text-green-600 font-bold">● Có hình ảnh đính kèm</div>` : ''}
                </div>
            `).join('');
        }

        // Init
        updateChecklist();
    </script>
</body>
</html>
